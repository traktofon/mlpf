#!/bin/bash
# vim: set ts=3 sw=3 expandtab:

tmpdep="dep$$.tmp"
objdir="$1"
shift
nfiles=$#
try=1
while ! gfortran -cpp -MM -J${objdir} "$@" >|${tmpdep} 2>/dev/null; do
   try=$[$try+1]
   if [ $try -gt $nfiles ]; then
      echo "Cannot generate dependencies after ${nfiles} iterations." >&2
      exit 1
   fi
done
echo "Generated dependencies after ${try} iterations." >&2
cat ${tmpdep} | sed -e "s@^\(\S\)@${objdir}/\1@"
rm -f ${tmpdep}
